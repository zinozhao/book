<!doctype html>
<html lang="zh-CN">
<head>
  <!-- Base -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cryptoç®€å² Â· ç›®å½•</title>
  <meta name="description" content="A Brief History of Crypto Â· ä½œè€…ï¼šZinoï¼ˆèµµæ‹©èƒ½ï¼‰" />
  <link rel="canonical" href="https://zinozhao.github.io/book/index.html" />
  <meta name="theme-color" content="#0d0d0d" />

  <!-- Open Graph (WeChat/FB etc.) -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Cryptoç®€å²" />
  <meta property="og:title" content="Cryptoç®€å²" />
  <meta property="og:description" content="A Brief History of Crypto Â· ä½œè€…ï¼šZinoï¼ˆèµµæ‹©èƒ½ï¼‰" />
  <meta property="og:url" content="https://zinozhao.github.io/book/index.html" />
  <meta property="og:image" content="https://zinozhao.github.io/book/assets/og-image-wechat.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Cryptoç®€å²" />
  <meta name="twitter:description" content="A Brief History of Crypto Â· ä½œè€…ï¼šZinoï¼ˆèµµæ‹©èƒ½ï¼‰" />
  <meta name="twitter:image" content="https://zinozhao.github.io/book/assets/og-image-wechat.png" />

  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="https://zinozhao.github.io/book/assets/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="https://zinozhao.github.io/book/assets/icon-512.png" />
  <link rel="apple-touch-icon" href="https://zinozhao.github.io/book/assets/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Cryptoç®€å²" />

  <style>
    :root { --cshell-accent:#7aa2ff; --cshell-accent2:#9a7aff; --cshell-fg:#eaeaea; --cshell-muted:#9aa3b2; --cshell-bg:#0b0c12; --cshell-card:#12131a; --cshell-border:#1c1e26; }
    #cshell-app, #cshell-app * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:#000; }
    #cshell-app { position: fixed; inset: 0; background: var(--cshell-bg); color: var(--cshell-fg);
      font-family: -apple-system,BlinkMacSystemFont,"SF Pro Text","PingFang SC","Hiragino Sans GB","Segoe UI",Roboto,Arial,"Noto Sans CJK SC",sans-serif; overflow: hidden; }

    /* top reading progress (per chapter scroll) */
    #cshell-progress { position: fixed; left:0; right:0; top:0; height: 3px; z-index:6; background: rgba(255,255,255,.06); }
    #cshell-progress.hidden { display:none; }
    #cshell-progress-bar { height:100%; width:0%; background: linear-gradient(90deg, var(--cshell-accent), var(--cshell-accent2)); transition: width .15s ease; }

    /* toc + bookmarks */
    #cshell-toc { position:absolute; inset:0; touch-action: pan-y; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; padding: env(safe-area-inset-top) 12px calc(72px + env(safe-area-inset-bottom)) 12px; overflow:auto; }
    .cshell-tabs { display:flex; gap:10px; position:sticky; top: max(8px, env(safe-area-inset-top)); z-index:2; background: linear-gradient(180deg, rgba(11,12,18,.98), rgba(11,12,18,.8)); padding:8px 6px; border-radius:12px; border:1px solid var(--cshell-border); backdrop-filter: blur(6px); }
    .cshell-tab { flex:1; text-align:center; padding:10px 0; border-radius:10px; color: var(--cshell-muted); border:1px solid var(--cshell-border); background: var(--cshell-card); }
    .cshell-tab[aria-selected="true"] { color:#fff; background: linear-gradient(135deg, var(--cshell-card), rgba(122,162,255,.12)); border-color: rgba(122,162,255,.3); font-weight:600; }
    .cshell-section { margin-top:12px; }
    .cshell-part { color:var(--cshell-muted); font-size:14px; margin:20px 0 20px 14px; }
    .cshell-list { list-style:none; margin:0; padding:0; display:grid; grid-template-columns: 1fr; gap:10px; }
    .cshell-item { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 14px; border:1px solid var(--cshell-border); border-radius:12px; background: var(--cshell-card);  cursor:pointer;}
    .cshell-item a { color:#fff; text-decoration:none; font-weight:600; }

    .cshell-resume { margin:16px 0 2px; padding:10px 12px; border:1px dashed rgba(122,162,255,.35); border-radius:10px; color:#d9e2ff; background: rgba(122,162,255,.08); display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .cshell-resume button { background: linear-gradient(135deg, var(--cshell-accent), var(--cshell-accent2)); color:#fff; border:none; padding:8px 12px; border-radius:999px; }

    .cshell-bmk { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border:1px solid var(--cshell-border); border-radius:12px; background: var(--cshell-card); }
    .cshell-bmk .meta { color:var(--cshell-muted); font-size:12px; }
    .cshell-bmk .act { display:flex; gap:8px; }
    .cshell-bmk .act button { border:1px solid var(--cshell-border); background:transparent; color:#fff; padding:6px 10px; border-radius:8px; }

    #cshell-reader { position:absolute; inset:0; }
    #cshell-frame { position:absolute; inset:0; width:100vw; height:100dvh; border:none; background:#fff; }

    #cshell-nav { position: fixed; left: 0; right: 0; bottom: 10px; display:flex; justify-content:center; pointer-events:none; z-index: 5; }
    .cshell-nav-wrap { pointer-events:auto; display:flex; gap:10px; padding:8px; border-radius:16px; background: rgba(9,10,16,.8); border:1px solid var(--cshell-border); backdrop-filter: blur(10px); }
    .cshell-btn { position:relative; appearance:none; border:none; border-radius:12px; padding:12px 14px; min-width:88px; overflow:hidden; background: linear-gradient(135deg, rgba(122,162,255,.16), rgba(154,122,255,.16)); color:#fff; font-weight:700; }
    .cshell-btn[disabled] { opacity:.4; }
    .cshell-btn--primary { background: linear-gradient(135deg, var(--cshell-accent), var(--cshell-accent2)); }
    .cshell-btn .cshell-btn-bar { position:absolute; left:0; top:0; bottom:0; width:0%; background: linear-gradient(135deg, rgba(255,255,255,.25), rgba(255,255,255,.15)); pointer-events:none; }
    .cshell-btn .cshell-btn-label { position:relative; z-index:1; }

    .cshell-hidden { display:none !important; }

    #cshell-bookmark { position: fixed; top: max(8px, calc(env(safe-area-inset-top) + 8px)); right: 10px; z-index:6; background: #e11d48; color:#fff; border:none; border-radius:12px; padding:10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,.18); }

    .cshell-toast { position: fixed; left:50%; transform: translateX(-50%); bottom: calc(64px + env(safe-area-inset-bottom)); background: rgba(0,0,0,.85); color:#fff; padding:10px 14px; border-radius:10px; z-index:7; opacity:0; transition:.25s opacity ease; }
    .cshell-toast.show { opacity:1; }
  
    .cshell-chapno{opacity:.85;margin-right:.4em;white-space:nowrap;}
    
    /* Mobile scroll safety: keep overlays from eating gestures */
    #cshell-nav { pointer-events: none; }
    .cshell-nav-wrap, .cshell-nav-wrap * { pointer-events: auto; }

    /* Make the main containers explicit scroll areas */
    html, body { -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain; }

  
    /* iOS nested scroll robustness */
    #cshell-toc {
      will-change: transform;
      transform: translateZ(0);
    }
    html, body {
      overscroll-behavior-y: none; /* keep rubber-band from bubbling to the top-level */
    }

  </style>
</head>
<body>
  <div id="cshell-app" aria-live="polite">
    <div id="cshell-progress" class="hidden" aria-hidden="true"><div id="cshell-progress-bar"></div></div>

    <section id="cshell-toc" role="navigation" aria-label="ç›®å½•">
      <div class="cshell-tabs" role="tablist">
        <button id="cshell-tab-toc" class="cshell-tab" role="tab" aria-selected="true">ç›®å½•</button>
        <button id="cshell-tab-bmk" class="cshell-tab" role="tab" aria-selected="false">ä¹¦ç­¾</button>
      </div>

      <div id="cshell-resume" class="cshell-resume cshell-hidden">
        <div>ä¸Šæ¬¡è¯»åˆ°ï¼š<span id="cshell-resume-title"></span></div>
        <button id="cshell-resume-btn">ç»§ç»­é˜…è¯»</button>
      </div>

      <div id="cshell-toc-list" class="cshell-section"></div>

      <div id="cshell-bmk-list" class="cshell-section cshell-hidden">
        <div class="cshell-part">æˆ‘çš„ä¹¦ç­¾</div>
        <div id="cshell-bmk-empty" class="cshell-bmk">æš‚æ— ä¹¦ç­¾ï¼Œåœ¨é˜…è¯»æ—¶ç‚¹å³ä¸Šè§’çº¢ä¸å¸¦å³å¯æ·»åŠ ã€‚</div>
        <ul id="cshell-bmk-items" class="cshell-list"></ul>
      </div>
    </section>

    <section id="cshell-reader" class="cshell-hidden" aria-label="é˜…è¯»å™¨">
      <iframe id="cshell-frame" title="ç« èŠ‚é˜…è¯»å™¨" referrerpolicy="no-referrer" loading="eager"></iframe>
    </section>

    <div id="cshell-nav" class="cshell-hidden">
      <div class="cshell-nav-wrap">
        <button id="cshell-prev" class="cshell-btn" aria-label="ä¸Šä¸€é¡µ"><span class="cshell-btn-label">ä¸Šä¸€é¡µ</span></button>
        <button id="cshell-toc-btn" class="cshell-btn cshell-btn--primary" aria-label="ç›®å½•ï¼ˆé¡µæ•°è¿›åº¦ï¼‰">
          <div class="cshell-btn-bar" id="cshell-btn-progress" aria-hidden="true"></div>
          <span class="cshell-btn-label">ç›®å½•</span>
        </button>
        <button id="cshell-next" class="cshell-btn" aria-label="ä¸‹ä¸€é¡µ"><span class="cshell-btn-label">ä¸‹ä¸€é¡µ</span></button>
      </div>
    </div>

    <button id="cshell-bookmark" class="cshell-hidden" aria-label="æ·»åŠ ä¹¦ç­¾">ğŸ”– ä¹¦ç­¾</button>

    <div id="cshell-toast" class="cshell-toast" role="status" aria-live="polite">å·²æ·»åŠ åˆ°ä¹¦ç­¾</div>
  </div>

  <script>
  (function(){
    'use strict';
    const QS = (sel, root=document) => root.querySelector(sel);
    const QSA = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const $toc = QS('#cshell-toc');
    const $reader = QS('#cshell-reader');
    const $frame = QS('#cshell-frame');
    const $nav = QS('#cshell-nav');
    const $prev = QS('#cshell-prev');
    const $next = QS('#cshell-next');
    const $tocBtn = QS('#cshell-toc-btn');
    const $bookmarkBtn = QS('#cshell-bookmark');
    const $toast = QS('#cshell-toast');
    const $resumeWrap = QS('#cshell-resume');
    const $resumeTitle = QS('#cshell-resume-title');
    const $resumeBtn = QS('#cshell-resume-btn');
    const $tocListWrap = QS('#cshell-toc-list');
    const $bmkListWrap = QS('#cshell-bmk-list');
    const $bmkEmpty = QS('#cshell-bmk-empty');
    const $bmkItems = QS('#cshell-bmk-items');
    const $tabToc = QS('#cshell-tab-toc');
    const $tabBmk = QS('#cshell-tab-bmk');
    const $progress = QS('#cshell-progress');
    const $progressBar = QS('#cshell-progress-bar');
    const $btnProgress = QS('#cshell-btn-progress');
    // Keep the original index title to restore when returning to TOC
    const ORIG_TITLE = document.title;
    function setDocTitleForChapter(i, doc){
      try{
        const t = (doc && doc.title && doc.title.trim()) ? doc.title.trim() : (CHAPTERS[i] ? CHAPTERS[i].title : '');
        if (t) document.title = t;
      }catch(e){ /* noop */ }
    }

    // --- Cache-busting version param from URL, e.g. index.html?v=12345 ---
    const __CSHELL_V__ = new URLSearchParams(location.search).get('v') || '';
    const withV = (url) => __CSHELL_V__ ? (url + (url.includes('?') ? '&' : '?') + 'v=' + encodeURIComponent(__CSHELL_V__)) : url;


    const LS = window.localStorage;
    const KEY_LAST = 'cshell:last';
    const KEY_BMK = 'cshell:bookmarks';

    let CHAPTERS = [];
    let currentIndex = -1;
    let scrollTimer = null;

    const ENABLE_SEGMENTED_RESTORE = true;
    // Map each ç¼– to its full display title
    const PART_TITLES = {
      'ç¬¬ä¸€ç¼–': 'ç¬¬ä¸€ç¼–ï¼ˆ1970sâ€“2008ï¼‰è§‚å¿µä¸æŠ€æœ¯çš„æºæµ',
      'ç¬¬äºŒç¼–': 'ç¬¬äºŒç¼–ï¼ˆ2008â€“2014ï¼‰æ¯”ç‰¹å¸çš„å‘æ˜ä¸æ—©æœŸæ‰©æ•£',
      'ç¬¬ä¸‰ç¼–': 'ç¬¬ä¸‰ç¼–ï¼ˆ2014â€“2016ï¼‰æ™ºèƒ½åˆçº¦ä¸é€šç”¨è®¡ç®—',
      'ç¬¬å››ç¼–': 'ç¬¬å››ç¼–ï¼ˆ2017â€“2019ï¼‰ICO ç‹‚æ½®ä¸ç›‘ç®¡è§‰é†’',
      'ç¬¬äº”ç¼–': 'ç¬¬äº”ç¼–ï¼ˆ2020â€“2021ï¼‰DeFi ä¸é“¾ä¸Šæ–‡åŒ–',
      'ç¬¬å…­ç¼–': 'ç¬¬å…­ç¼–ï¼ˆ2022â€“2023ï¼‰å±æœºã€æ²»ç†ä¸è¡Œä¸šé‡æ„',
      'ç¬¬ä¸ƒç¼–': 'ç¬¬ä¸ƒç¼–ï¼ˆ2024â€“2025ï¼‰åˆ¶åº¦åŒ–ä¸æ‰©å±•æ€§ä¸ RWA èµ·åŠ¿',
      'ç»ˆç¼–':   'ç»ˆç¼–ï¼ˆ2025â€“2035ï¼‰æœªæ¥æƒ…æ™¯ä¸é¢†å…ˆæŒ‡æ ‡'
    };
    function partDisplay(part, years){
      if (PART_TITLES[part]) return PART_TITLES[part];
      return years ? `${part}ï¼ˆ${years}ï¼‰` : `${part}`;
    }


    function show(el){ el.classList.remove('cshell-hidden'); }
    function hide(el){ el.classList.add('cshell-hidden'); }
    function toast(msg='å·²æ·»åŠ åˆ°ä¹¦ç­¾'){ $toast.textContent = msg; $toast.classList.add('show'); setTimeout(()=> $toast.classList.remove('show'), 1400); }
    function getLast(){ try { return JSON.parse(LS.getItem(KEY_LAST) || 'null'); } catch(e){ return null; } }
    function setLast(obj){ try { LS.setItem(KEY_LAST, JSON.stringify(obj)); } catch(e){} }
    function getBmk(){ try { return JSON.parse(LS.getItem(KEY_BMK) || '[]'); } catch(e){ return []; } }
    function setBmk(list){ try { LS.setItem(KEY_BMK, JSON.stringify(list)); } catch(e){} }
    function ratioToPx(doc, ratio){ const el = doc.scrollingElement || doc.documentElement || doc.body; const max = el.scrollHeight - el.clientHeight; return Math.max(0, Math.min(max, Math.round(max * ratio))); }
    function pxToRatio(doc){ const el = doc.scrollingElement || doc.documentElement || doc.body; const max = el.scrollHeight - el.clientHeight || 1; return Math.max(0, Math.min(1, el.scrollTop / max)); }
    function setScrollProgress(r){ if ($progressBar) $progressBar.style.width = Math.round(r*100) + '%'; }
    function setPageProgress(index){ if (!CHAPTERS.length) return; const r = Math.max(0, Math.min(1, (index+1)/CHAPTERS.length)); if ($btnProgress) $btnProgress.style.width = Math.round(r*100) + '%'; $tocBtn.setAttribute('aria-label', `ç›®å½•ï¼ˆ${index+1}/${CHAPTERS.length}ï¼‰`); }
    function updateResumeCard(){ const last = getLast(); if (last && CHAPTERS[last.index]){ $resumeTitle.textContent = CHAPTERS[last.index].title.replace(/^ç¬¬ä¸€ç¼–_/,'') + (typeof last.scrollRatio==='number' ? ` Â· ${Math.round(last.scrollRatio*100)}%` : ''); show($resumeWrap); } else { hide($resumeWrap); } }
    function snapshotProgress(){ try { const doc = $frame.contentDocument; if (!doc) return; const ratio = pxToRatio(doc); const cur = getLast() || {}; if (typeof ratio === 'number' && cur && cur.index === currentIndex){ cur.scrollRatio = ratio; setLast(cur); } } catch(e){} }

    // Promise-based robust restore
    function robustRestore(doc, desiredRatio){
      return new Promise((resolve) => {
        try{
          const el = doc.scrollingElement || doc.documentElement || doc.body;
          let attempts = 50; // up to ~2.5s
          let lastH = 0;
          function tick(){
            try{
              const H = el.scrollHeight;
              const targetPx = ratioToPx(doc, desiredRatio);
              el.scrollTop = targetPx;
              const near = Math.abs(el.scrollTop - targetPx) <= 3;
              const heightStable = Math.abs(H - lastH) <= 2;
              setScrollProgress(pxToRatio(doc));
              if (near && heightStable){ resolve(true); return; }
              lastH = H;
              if (attempts-- > 0){ setTimeout(tick, 50); } else { resolve(false); }
            }catch(e){ resolve(false); }
          }
          try {
            const imgs = doc.images || [];
            for (const im of imgs){ if (!im.complete){ im.addEventListener('load', ()=> setTimeout(tick, 30), {once:true}); } }
            if (doc.fonts && doc.fonts.ready){ doc.fonts.ready.then(()=> setTimeout(tick, 30)); }
          } catch(e){}
          setTimeout(tick, 30);
        }catch(e){ resolve(false); }
      });
    }

    // staged ratios for segmented restore
    function stagedRatios(t){
      t = Math.max(0, Math.min(1, t));
      const stages = [];
      if (t < 0.15) return [t];
      stages.push(0.2);
      if (t > 0.35) stages.push(0.5);
      if (t > 0.70) stages.push(0.8);
      if (t > 0.90) stages.push(0.95);
      stages.push(t);
      const uniq = [...new Set(stages)].sort((a,b)=>a-b);
      return uniq;
    }

    async function segmentedRestore(doc, t){
      if (!ENABLE_SEGMENTED_RESTORE) return robustRestore(doc, t);
      const seq = stagedRatios(t);
      for (const r of seq){
        await robustRestore(doc, r);
      }
    }

    function selectTab(which){
      if (which === 'toc'){ $tabToc.setAttribute('aria-selected','true'); $tabBmk.setAttribute('aria-selected','false'); hide($bmkListWrap); show(QS('#cshell-toc-list')); }
      else { $tabToc.setAttribute('aria-selected','false'); $tabBmk.setAttribute('aria-selected','true'); hide(QS('#cshell-toc-list')); renderBookmarks(); show($bmkListWrap); }
    }
    $tabToc.addEventListener('click', ()=> selectTab('toc'));
    $tabBmk.addEventListener('click', ()=> selectTab('bmk'));

    async function initTOC(){
        CHAPTERS = [
    {
      "number": 1,
      "part": "ç¬¬ä¸€ç¼–",
      "years": "1970sâ€“2008",
      "title": "å¯†ç å­¦å¥ åŸº",
      "file": "ç¬¬ä¸€ç¼–_ç¬¬1ç« _å¯†ç å­¦å¥ åŸº.html"
    },
    {
      "number": 2,
      "part": "ç¬¬ä¸€ç¼–",
      "years": "1970sâ€“2008",
      "title": "å¯†ç æœ‹å…‹çš„æ”¿æ²»",
      "file": "ç¬¬ä¸€ç¼–_ç¬¬2ç« _å¯†ç æœ‹å…‹çš„æ”¿æ²».html"
    },
    {
      "number": 3,
      "part": "ç¬¬ä¸€ç¼–",
      "years": "1970sâ€“2008",
      "title": "ç”µå­ç°é‡‘å…ˆé©±",
      "file": "ç¬¬ä¸€ç¼–_ç¬¬3ç« _ç”µå­ç°é‡‘å…ˆé©±.html"
    },
    {
      "number": 4,
      "part": "ç¬¬ä¸€ç¼–",
      "years": "1970sâ€“2008",
      "title": "æœªç«Ÿä¹‹ä¸š",
      "file": "ç¬¬ä¸€ç¼–_ç¬¬4ç« _æœªç«Ÿä¹‹ä¸š.html"
    },
    {
      "number": 5,
      "part": "ç¬¬äºŒç¼–",
      "years": "2008â€“2014",
      "title": "ç™½çš®ä¹¦ä¸åˆ›ä¸–",
      "file": "ç¬¬äºŒç¼–_ç¬¬5ç« _ç™½çš®ä¹¦ä¸åˆ›ä¸–.html"
    },
    {
      "number": 6,
      "part": "ç¬¬äºŒç¼–",
      "years": "2008â€“2014",
      "title": "éš¾åº¦ä¸æŒ–çŸ¿",
      "file": "ç¬¬äºŒç¼–_ç¬¬6ç« _éš¾åº¦ä¸æŒ–çŸ¿.html"
    },
    {
      "number": 7,
      "part": "ç¬¬äºŒç¼–",
      "years": "2008â€“2014",
      "title": "ä»·æ ¼å‘ç°ä¸äº¤æ˜“æ‰€",
      "file": "ç¬¬äºŒç¼–_ç¬¬7ç« _ä»·æ ¼å‘ç°ä¸äº¤æ˜“æ‰€.html"
    },
    {
      "number": 8,
      "part": "ç¬¬äºŒç¼–",
      "years": "2008â€“2014",
      "title": "æŠ—å®¡æŸ¥ä¸ç°è‰²ç”¨ä¾‹",
      "file": "ç¬¬äºŒç¼–_ç¬¬8ç« _æŠ—å®¡æŸ¥ä¸ç°è‰²ç”¨ä¾‹.html"
    },
    {
      "number": 9,
      "part": "ç¬¬äºŒç¼–",
      "years": "2008â€“2014",
      "title": "åè®®æ”¹è¿›ä¸æ²»ç†èŒèŠ½",
      "file": "ç¬¬äºŒç¼–_ç¬¬9ç« _åè®®æ”¹è¿›ä¸æ²»ç†èŒèŠ½.html"
    },
    {
      "number": 10,
      "part": "ç¬¬äºŒç¼–",
      "years": "2008â€“2014",
      "title": "æ‰©å±•æ€§éšå¿§",
      "file": "ç¬¬äºŒç¼–_ç¬¬10ç« _æ‰©å±•æ€§éšå¿§.html"
    },
    {
      "number": 11,
      "part": "ç¬¬äºŒç¼–",
      "years": "2008â€“2014",
      "title": "å°ç»“",
      "file": "ç¬¬äºŒç¼–_ç¬¬11ç« _å°ç»“.html"
    }
        ];

      // Render grouped by ç¼–ï¼ˆpartï¼‰ï¼Œä¸æ”¹å˜ CHAPTERS çš„æ•°æ®ç»“æ„
      $tocListWrap.innerHTML = '';
      let lastPart = null;
      let curUL = null;
      for (let i = 0; i < CHAPTERS.length; i++){
        const c = CHAPTERS[i];
        if (c.part !== lastPart){
          const hd = document.createElement('div');
          hd.className = 'cshell-part';
          hd.textContent = partDisplay(c.part, c.years);
          $tocListWrap.appendChild(hd);

          curUL = document.createElement('ul');
          curUL.className = 'cshell-list';
          curUL.setAttribute('data-part', c.part);
          $tocListWrap.appendChild(curUL);

          lastPart = c.part;
        }
        const li = document.createElement('li');
li.className = 'cshell-item';
const chapNo = i + 1;
li.setAttribute('data-i', i);
li.setAttribute('role', 'button');
li.setAttribute('tabindex', '0');
li.innerHTML = `<div class=\"cshell-item__inner\"><span class=\"cshell-chapno\">ç¬¬${chapNo}ç« </span>${c.title}</div>`;
        curUL.appendChild(li);
      }

      updateResumeCard();

      // click handlers
      QSA('.cshell-item[data-i]', $tocListWrap).forEach(li => {
  li.addEventListener('click', () => {
    const i = parseInt(li.getAttribute('data-i'), 10);
    openChapter(i);
    history.pushState({read:i}, '', `#read?i=${i}`);
  });
  li.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      const i = parseInt(li.getAttribute('data-i'), 10);
      openChapter(i);
      history.pushState({read:i}, '', `#read?i=${i}`);
    }
  });
});

      $resumeBtn.addEventListener('click', ()=>{ const last2 = getLast(); if (last2 && CHAPTERS[last2.index]){ openChapter(last2.index, { restoreLast: true }); history.pushState({read:last2.index}, '', `#read?i=${last2.index}`); } });
    }

    function renderBookmarks(){
      const list = getBmk();
      $bmkItems.innerHTML = '';
      if (!list.length){ show($bmkEmpty); return; } else { hide($bmkEmpty); }
      list.forEach((bmk, idx) => {
        const li = document.createElement('li');
        li.className = 'cshell-bmk';
        const c = CHAPTERS[bmk.index] || {title:bmk.title || 'æœªçŸ¥ç« èŠ‚', file:bmk.file || ''};
        li.innerHTML = `<div><div><strong>${c.title.replace(/^ç¬¬ä¸€ç¼–_/,'')}</strong></div><div class="meta">${new Date(bmk.ts||Date.now()).toLocaleString()} Â· è¿›åº¦ ${Math.round((bmk.scrollRatio||0)*100)}%</div></div><div class="act"><button data-act="go" data-i="${bmk.index}">æ‰“å¼€</button><button data-act="del" data-k="${idx}">åˆ é™¤</button></div>`;
        $bmkItems.appendChild(li);
      });
      QSA('button[data-act="go"]', $bmkItems).forEach(btn => { btn.addEventListener('click', ()=> { const i = parseInt(btn.getAttribute('data-i'),10); openChapter(i, { restoreFromBookmark: true }); history.pushState({read:i}, '', `#read?i=${i}`); selectTab('toc'); }); });
      QSA('button[data-act="del"]', $bmkItems).forEach(btn => { btn.addEventListener('click', ()=> { const k = parseInt(btn.getAttribute('data-k'),10); const list2 = getBmk(); list2.splice(k,1); setBmk(list2); renderBookmarks(); toast('ä¹¦ç­¾å·²åˆ é™¤'); }); });
    }

    function toTOC(){
      snapshotProgress();
      if (scrollTimer){ clearInterval(scrollTimer); scrollTimer = null; }
      hide($reader); hide($nav); hide($bookmarkBtn);
      if ($progress) $progress.classList.add('hidden');
      updateResumeCard();
      show($toc);
      document.title = ORIG_TITLE;
    }

    function openChapter(i, opts={}){
      currentIndex = i;
      const ch = CHAPTERS[i]; if (!ch) return;
      hide($toc); show($reader); show($nav); show($bookmarkBtn);
      if ($progress) $progress.classList.remove('hidden');
      $prev.disabled = (i<=0); $next.disabled = (i>=CHAPTERS.length-1);
      setPageProgress(i);

      // å…ˆå¾—åˆ°ç›®æ ‡æ¯”ä¾‹ï¼ˆä¸ä¹¦ç­¾ä¸€è‡´çš„æ–¹å¼ï¼‰ï¼Œå†ä¿å­˜ä¸º lastï¼Œé¿å…è¢« 0 è¦†ç›–
      let targetRatio = 0;
      const prev = getLast();
      if (opts.restoreLast && prev && prev.index === i && typeof prev.scrollRatio === 'number'){
        targetRatio = prev.scrollRatio || 0;
      } else if (opts.restoreFromBookmark){
        const bm = (getBmk().filter(b=>b.index===i).sort((a,b)=>(b.ts||0)-(a.ts||0)))[0];
        if (bm) targetRatio = bm.scrollRatio || 0;
      }
      setLast({ index:i, file:ch.file, title:ch.title, scrollRatio: targetRatio });
      setScrollProgress(targetRatio);

      $frame.src = withV(`./chapters/${encodeURIComponent(ch.file)}`);
      $frame.onload = async ()=>{
        try {
          const doc = $frame.contentDocument;
          const style = doc.createElement('style'); style.textContent = `html,body{margin:0!important;padding:0!important;}`; doc.head.appendChild(style);
          await segmentedRestore(doc, targetRatio);
          // Ensure title after potential dynamic updates
          try { if (doc && doc.title) setDocTitleForChapter(i, doc); } catch(e){}

          // live scroll update
          let tick = 0;
          doc.addEventListener('scroll', ()=>{ const now = Date.now(); if (now - tick < 80) return; tick = now; try{ const r = pxToRatio(doc); setScrollProgress(r); }catch(e){} }, { passive: true });

          // periodic save
          if (scrollTimer) clearInterval(scrollTimer);
          scrollTimer = setInterval(()=>{ try { const ratio = pxToRatio(doc); const cur = getLast() || {}; if (cur.index===i){ cur.scrollRatio = ratio; setLast(cur); setScrollProgress(ratio); } } catch(e){} }, 800);
        } catch(e){}
      };
    }

    $prev.addEventListener('click', ()=>{
      if (currentIndex > 0) {
        const target = currentIndex - 1;
        snapshotProgress();
        openChapter(target);
        history.pushState({read: target}, '', `#read?i=${target}`);
      }
    });
    $next.addEventListener('click', ()=>{
      if (currentIndex < CHAPTERS.length - 1) {
        const target = currentIndex + 1;
        snapshotProgress();
        openChapter(target);
        history.pushState({read: target}, '', `#read?i=${target}`);
      }
    });
    $tocBtn.addEventListener('click', ()=>{ toTOC(); history.pushState({toc:true}, '', '#toc'); });

    
    $bookmarkBtn.addEventListener('click', ()=>{
      try {
        const list = getBmk();
        const ch = CHAPTERS[currentIndex];
        let ratio = 0;
        try { const doc = $frame.contentDocument; ratio = pxToRatio(doc); } catch(e){ ratio = 0; }

        // å¦‚æœè¯¥ç« èŠ‚å·²æœ‰ä¹¦ç­¾ï¼šæ›´æ–°å…¶è¿›åº¦ä¸æ—¶é—´æˆ³å¹¶ç§»åˆ°æœ€å‰ï¼Œè€Œä¸æ˜¯æ–°å¢ä¸€æ¡
        const idx = list.findIndex(b => b.index === currentIndex);
        if (idx >= 0){
          const item = list.splice(idx, 1)[0] || {};
          item.index = currentIndex;
          item.file = ch.file;
          item.title = ch.title;
          item.scrollRatio = ratio;
          item.ts = Date.now();
          list.unshift(item);
          setBmk(list.slice(0,200));
          toast('ä¹¦ç­¾å·²æ›´æ–°');
          return;
        }

        // å¦åˆ™æ–°å¢
        list.unshift({ index: currentIndex, file: ch.file, title: ch.title, ts: Date.now(), scrollRatio: ratio });
        setBmk(list.slice(0,200));
        toast('å·²æ·»åŠ ä¹¦ç­¾');
      } catch(e){ toast('æ— æ³•æ·»åŠ ä¹¦ç­¾'); }
    });
window.addEventListener('popstate', ()=>{ const hash = location.hash || ''; if (hash.startsWith('#read')){ const params = new URLSearchParams(hash.split('?')[1] || ''); const i = parseInt(params.get('i') || '-1', 10); if (!isNaN(i) && i>=0){ openChapter(i, { restoreLast: true }); } } else { toTOC(); } });

    (async function boot(){
      await initTOC();
      if (location.hash.startsWith('#read')){ const params = new URLSearchParams(location.hash.split('?')[1] || ''); const i = parseInt(params.get('i') || '-1', 10); if (!isNaN(i) && i>=0){ openChapter(i, { restoreLast: true }); return; } }
      toTOC();
    })();

  })();

  // --- Mobile viewport fit (iOS Safari 100vh fix) ---
  (function(){
    function fitViewport(){
      var h = window.innerHeight;
      var fr = document.getElementById('cshell-frame');
      if (fr) fr.style.height = h + 'px';
      // If there are other absolute full-viewport containers, set their min-height for safety
      var reader = document.getElementById('cshell-reader');
      if (reader) reader.style.minHeight = h + 'px';
      var toc = document.getElementById('cshell-toc');
      if (toc) toc.style.minHeight = h + 'px';
    }
    window.addEventListener('resize', fitViewport);
    window.addEventListener('orientationchange', fitViewport);
    document.addEventListener('DOMContentLoaded', fitViewport);
    fitViewport();
  })();


  // --- Overscroll guard: prevent iOS rubber-band from breaking inner scroll ---
  (function(){
    function attachOverscrollGuard(el){
      if (!el) return;
      let startY = 0;
      let lastY = 0;
      let started = false;
      el.addEventListener('touchstart', function(ev){
        if (!ev.touches || ev.touches.length !== 1) return;
        started = true;
        startY = lastY = ev.touches[0].clientY;
      }, { passive: true });
      el.addEventListener('touchmove', function(ev){
        if (!started || !ev.touches || ev.touches.length !== 1) return;
        const y = ev.touches[0].clientY;
        const dy = y - lastY;
        lastY = y;
        const atTop = el.scrollTop <= 0;
        const atBottom = (el.scrollTop + el.clientHeight >= el.scrollHeight - 1);
        // Only prevent when we're at a boundary ANDç»§ç»­å¾€è¾¹ç•Œæ–¹å‘æ‹–
        if ((atTop && dy > 0) || (atBottom && dy < 0)){
          if (ev.cancelable) ev.preventDefault();
        }
      }, { passive: false });
      el.addEventListener('touchend', function(){ started = false; }, { passive: true });
      el.addEventListener('touchcancel', function(){ started = false; }, { passive: true });
    }
    document.addEventListener('DOMContentLoaded', function(){
      attachOverscrollGuard(document.getElementById('cshell-toc'));
      attachOverscrollGuard(document.getElementById('cshell-bmk')); // ä¹¦ç­¾é¡µä¹Ÿä¿æŠ¤ä¸€ä¸‹
    });
  })();

  </script>
</body>
</html>
